<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>WordRain ğŸ€ JLPT N3</title>

  <style>
    /* âœ… Font */
    @font-face {
      font-family: 'Galmuri14';
      src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/2506-1@1.0/Galmuri14.woff2') format('woff2');
      font-weight: normal;
      font-display: swap;
    }

    :root{
      --bg:#fff6fb;
      --panel:#ffffffcc;
      --text:#3a2a33;
      --muted:#8b6b7c;
      --accent:#ff6fb3;
      --accent2:#ffb7d6;
      --danger:#ff4d6d;
      --ok:#2ecc71;
      --line: rgba(255, 111, 179, 0.25);
      --shadow: rgba(255, 111, 179, 0.18);
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: 'Galmuri14', system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", sans-serif;
      background:
        radial-gradient(900px 600px at 30% 20%, #ffe3f1, transparent 60%),
        radial-gradient(900px 600px at 80% 30%, #ffeaf6, transparent 55%),
        linear-gradient(180deg, var(--bg), #ffffff);
      color:var(--text);
      display:flex;
      justify-content:center;
      padding:20px;
    }

    .app{
      width:min(980px, 100%);
      display:grid;
      grid-template-columns: 1fr 320px;
      gap:16px;
    }

    .game{
      background: linear-gradient(180deg, rgba(255,255,255,0.95), rgba(255,255,255,0.80));
      border: 2px solid var(--line);
      border-radius: 22px;
      overflow:hidden;
      box-shadow: 0 18px 50px var(--shadow);
      position:relative;
      height: 640px;
    }

    .rain-zone{
      position:absolute; inset:0;
      padding:14px;
    }

    .word{
      position:absolute;
      padding:10px 12px;
      border-radius:16px;
      background: rgba(255, 255, 255, 0.92);
      border: 2px solid rgba(255, 111, 179, 0.35);
      box-shadow: 0 10px 22px rgba(255, 111, 179, 0.16);
      backdrop-filter: blur(6px);
      font-weight: 900;
      letter-spacing: 0.2px;
      user-select:none;
      white-space:nowrap;
    }
    .word::before{
      content:"ğŸ€";
      margin-right:6px;
    }
    .word small{
      display:block;
      font-size:12px;
      font-weight:700;
      color: var(--muted);
      margin-top:4px;
    }

    .hud{
      position:absolute;
      left:14px; right:14px; bottom:14px;
      display:flex;
      gap:10px;
      align-items:center;
      padding:12px;
      border-radius:18px;
      background: rgba(255, 255, 255, 0.86);
      border:2px solid var(--line);
      box-shadow: 0 10px 30px rgba(255, 111, 179, 0.10);
    }

    .hud input{
      flex:1;
      padding:12px 14px;
      border-radius:16px;
      border:2px solid rgba(255, 111, 179, 0.25);
      background: rgba(255, 240, 248, 0.9);
      color: var(--text);
      outline:none;
      font-size:16px;
    }

    .hud button{
      padding:12px 12px;
      border-radius:16px;
      border:2px solid rgba(255, 111, 179, 0.25);
      background: linear-gradient(180deg, #ffb7d6, #ff6fb3);
      color: #fff;
      cursor:pointer;
      font-weight:900;
      box-shadow: 0 10px 22px rgba(255, 111, 179, 0.18);
    }
    .hud button:hover{ filter: brightness(1.03); }
    .hud button:active{ transform: translateY(1px); }

    .side{
      display:flex;
      flex-direction:column;
      gap:16px;
    }

    .card{
      background: rgba(255,255,255,0.86);
      border:2px solid var(--line);
      border-radius:20px;
      padding:14px;
      box-shadow: 0 18px 50px rgba(255, 111, 179, 0.12);
    }

    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    .label{color:var(--muted); font-size:13px;}
    .big{font-size:20px; font-weight:900;}

    .pill{
      padding:6px 10px;
      border-radius:999px;
      border:2px solid rgba(255, 111, 179, 0.18);
      background: rgba(255, 235, 245, 0.65);
      font-size:13px;
      color: var(--text);
    }

    .hpbar{
      width:100%;
      height:10px;
      border-radius:999px;
      background: rgba(255, 111, 179, 0.12);
      overflow:hidden;
      border:2px solid rgba(255, 111, 179, 0.18);
    }
    .hpbar > div{
      height:100%;
      width:100%;
      background: linear-gradient(90deg, #7ae582, #ffd166, #ff4d6d);
      transition: width 120ms linear;
    }

    .log{
      min-height:48px;
      margin-top:10px;
      font-size:14px;
      color: var(--muted);
      line-height:1.4;
      white-space:pre-line;
    }

    select, .mini-btn{
      padding:10px 12px;
      border-radius:16px;
      border:2px solid rgba(255, 111, 179, 0.18);
      background: rgba(255, 240, 248, 0.9);
      color: var(--text);
      outline:none;
      font-weight:900;
      cursor:pointer;
    }
    .mini-btn{
      background: linear-gradient(180deg, rgba(255,183,214,0.55), rgba(255,111,179,0.35));
    }
    .mini-btn:hover{ filter: brightness(1.03); }

    .overlay{
      position:absolute; inset:0;
      background: rgba(255, 160, 205, 0.35);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      backdrop-filter: blur(3px);
    }

    .modal{
      width:min(560px, 100%);
      background: rgba(255,255,255,0.92);
      border:2px solid rgba(255, 111, 179, 0.25);
      border-radius:22px;
      padding:18px;
      text-align:left;
      box-shadow: 0 22px 60px rgba(255, 111, 179, 0.18);
    }
    .modal h2{ margin:0 0 8px; font-weight:900; }
    .modal p{ margin:8px 0; color: var(--muted); }
    .modal .actions{ display:flex; gap:10px; margin-top:14px; flex-wrap:wrap; }

    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      background: rgba(255, 111, 179, 0.12);
      border:2px solid rgba(255, 111, 179, 0.18);
      padding:2px 6px;
      border-radius:10px;
      color: var(--text);
      font-size:12px;
    }

    /* âœ¨ ë§ì¶œ ë•Œ ì´í™íŠ¸ */
    .sparkle{
      position:absolute;
      pointer-events:none;
      font-weight:900;
      animation: pop 650ms ease-out forwards;
      filter: drop-shadow(0 10px 16px rgba(255, 111, 179, 0.22));
    }
    @keyframes pop{
      0%{ transform: translateY(0) scale(0.8); opacity:0; }
      25%{ opacity:1; }
      100%{ transform: translateY(-26px) scale(1.05); opacity:0; }
    }
  </style>
</head>

<body>
  <div class="app">
    <div class="game" id="game">
      <div class="rain-zone" id="rainZone"></div>

      <div class="hud">
        <input id="answer" placeholder="í•œêµ­ì–´ ëœ» ì…ë ¥ í›„ Enter (ì˜ˆ: í™•ì¸í•˜ë‹¤)" autocomplete="off" />
        <button id="submitBtn">í™•ì¸</button>
        <button id="pauseBtn">ì¼ì‹œì •ì§€</button>
      </div>

      <div class="overlay" id="overlay">
        <div class="modal">
          <h2 id="modalTitle">ê²Œì„</h2>
          <p id="modalDesc"></p>
          <div class="actions">
            <button class="mini-btn" id="restartBtn">ë‹¤ì‹œ ì‹œì‘</button>
            <button class="mini-btn" id="nextLessonBtn">ë‹¤ìŒ ë ˆìŠ¨</button>
            <button class="mini-btn" id="reviewBtn">ì˜¤ë‹µ ë³µìŠµëª¨ë“œ</button>
            <button class="mini-btn" id="closeModalBtn">ë‹«ê¸°</button>
          </div>
          <p style="margin-top:12px">
            ë‹¨ì¶•í‚¤: <span class="kbd">Enter</span> ì œì¶œ, <span class="kbd">P</span> ì¼ì‹œì •ì§€
          </p>
        </div>
      </div>
    </div>

    <div class="side">
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <div>
            <div class="label">LESSON</div>
            <div class="big" id="lessonTitle">LESSON01</div>
          </div>
          <div class="pill" id="modePill">ëª¨ë“œ: ê¸°ë³¸</div>
        </div>

        <div style="height:10px"></div>

        <div class="row" style="justify-content:space-between">
          <div class="pill">ì ìˆ˜: <b id="score">0</b></div>
          <div class="pill">ì½¤ë³´: <b id="combo">0</b></div>
          <div class="pill">ì†ë„: <b id="speed">0.3</b>x</div>
        </div>

        <div style="height:12px"></div>

        <div class="label">HP</div>
        <div class="hpbar"><div id="hpFill"></div></div>

        <div class="log" id="log">ğŸ€ ë¦¬ë³¸ ì‚°ì„±ë¹„! í•œêµ­ì–´ ëœ»ì„ ì¹˜ê³  Enter!</div>
      </div>

      <div class="card">
        <div class="label">ë ˆìŠ¨ ì„ íƒ</div>
        <div class="row" style="margin-top:10px">
          <select id="lessonSelect"></select>
          <button class="mini-btn" id="startBtn">ì‹œì‘</button>
        </div>

        <div style="height:12px"></div>

        <div class="label">ì˜µì…˜</div>
        <div class="row" style="margin-top:10px">
          <button class="mini-btn" id="toggleReadingBtn">ìš”ë¯¸ê°€ë‚˜ í‘œì‹œ</button>
          <button class="mini-btn" id="toggleHintBtn">íŒíŠ¸(ì´ˆì„±) í‘œì‹œ</button>
        </div>

        <div style="height:12px"></div>

        <div class="label">ì§„í–‰</div>
        <div class="row" style="margin-top:10px">
          <div class="pill">ë‚¨ì€ ë‹¨ì–´: <b id="remain">0</b></div>
          <div class="pill">ì˜¤ë‹µ: <b id="wrongCount">0</b></div>
        </div>
      </div>

      <div class="card">
        <div class="label">ë‹¨ì–´ ë°ì´í„° ë„£ëŠ” ê³³</div>
        <p style="margin:8px 0 0; color:var(--muted); line-height:1.5; font-size:14px">
          <b>LESSONS</b>ì— N3 ë‹¨ì–´ë¥¼ ê³„ì† ì¶”ê°€í•˜ë©´ ë ˆìŠ¨ì´ ì­‰ ëŠ˜ì–´ë‚˜ìš” â˜”ğŸ’—<br/>
          ì •ë‹µì€ <b>ko ë°°ì—´</b>ë¡œ ë™ì˜ì–´ë„ í—ˆìš© ê°€ëŠ¥!
        </p>
      </div>
    </div>
  </div>

  <script>
    /***********************
     * 1) ë ˆìŠ¨ ë°ì´í„° (ì—¬ê¸°ì— N3 ë‹¨ì–´ ê³„ì† ì¶”ê°€!)
     ***********************/
    const LESSONS = {
      "LESSON01": [
        { jp: "ç¢ºèª", reading: "ã‹ãã«ã‚“", ko: ["í™•ì¸", "í™•ì¸í•˜ë‹¤", "ì ê²€", "ì ê²€í•˜ë‹¤"] },
        { jp: "å¿…è¦", reading: "ã²ã¤ã‚ˆã†", ko: ["í•„ìš”", "í•„ìš”í•˜ë‹¤"] },
        { jp: "å¤‰æ›´", reading: "ã¸ã‚“ã“ã†", ko: ["ë³€ê²½", "ë³€ê²½í•˜ë‹¤"] },
        { jp: "æº–å‚™", reading: "ã˜ã‚…ã‚“ã³", ko: ["ì¤€ë¹„", "ì¤€ë¹„í•˜ë‹¤"] },
        { jp: "ç´„æŸ", reading: "ã‚„ããã", ko: ["ì•½ì†"] },
        { jp: "çµŒé¨“", reading: "ã‘ã„ã‘ã‚“", ko: ["ê²½í—˜", "ê²½í—˜í•˜ë‹¤"] },
        { jp: "èª¬æ˜", reading: "ã›ã¤ã‚ã„", ko: ["ì„¤ëª…", "ì„¤ëª…í•˜ë‹¤"] },
        { jp: "ç¶šã‘ã‚‹", reading: "ã¤ã¥ã‘ã‚‹", ko: ["ê³„ì†í•˜ë‹¤", "ì´ì–´ê°€ë‹¤"] },
        { jp: "æ”¯æ‰•ã†", reading: "ã—ã¯ã‚‰ã†", ko: ["ì§€ë¶ˆí•˜ë‹¤", "ë‚´ë‹¤"] },
        { jp: "æ¯”ã¹ã‚‹", reading: "ãã‚‰ã¹ã‚‹", ko: ["ë¹„êµí•˜ë‹¤", "ë¹„êµ"] },
      ],
      "LESSON02": [
        { jp: "åˆæ ¼", reading: "ã”ã†ã‹ã", ko: ["í•©ê²©"] },
        { jp: "é€£çµ¡", reading: "ã‚Œã‚“ã‚‰ã", ko: ["ì—°ë½", "ì—°ë½í•˜ë‹¤"] },
        { jp: "äºˆç´„", reading: "ã‚ˆã‚„ã", ko: ["ì˜ˆì•½", "ì˜ˆì•½í•˜ë‹¤"] },
        { jp: "ç†ç”±", reading: "ã‚Šã‚†ã†", ko: ["ì´ìœ "] },
        { jp: "çµæœ", reading: "ã‘ã£ã‹", ko: ["ê²°ê³¼"] },
      ]
    };

    /***********************
     * 2) ìƒíƒœ
     ***********************/
    const state = {
      lessonKeys: Object.keys(LESSONS),
      lessonIndex: 0,
      mode: "base", // base | review
      showReading: true,
      showHint: false,

      running: false,
      paused: false,

      score: 0,
      combo: 0,
      hp: 100,

      spawnTimer: 0,
      // âœ… ëŠë¦¬ê²Œ(í•‘í¬ ê°ì„±) ì„¤ì •
      spawnInterval: 1600, // ms (ì²˜ìŒì—” ë„ë„í•˜ê²Œ)
      baseSpeed: 0.3,      // âœ… ìš”ì²­: 0.3xë¡œ ì‹œì‘

      activeWords: [],
      remainQueue: [],
      wrongList: [],

      lastTime: performance.now()
    };

    /***********************
     * 3) DOM
     ***********************/
    const rainZone = document.getElementById("rainZone");
    const answerEl = document.getElementById("answer");
    const submitBtn = document.getElementById("submitBtn");
    const pauseBtn = document.getElementById("pauseBtn");
    const startBtn = document.getElementById("startBtn");
    const lessonSelect = document.getElementById("lessonSelect");
    const lessonTitle = document.getElementById("lessonTitle");
    const modePill = document.getElementById("modePill");
    const scoreEl = document.getElementById("score");
    const comboEl = document.getElementById("combo");
    const speedEl = document.getElementById("speed");
    const hpFill = document.getElementById("hpFill");
    const logEl = document.getElementById("log");
    const remainEl = document.getElementById("remain");
    const wrongCountEl = document.getElementById("wrongCount");
    const toggleReadingBtn = document.getElementById("toggleReadingBtn");
    const toggleHintBtn = document.getElementById("toggleHintBtn");

    const overlay = document.getElementById("overlay");
    const modalTitle = document.getElementById("modalTitle");
    const modalDesc = document.getElementById("modalDesc");
    const restartBtn = document.getElementById("restartBtn");
    const nextLessonBtn = document.getElementById("nextLessonBtn");
    const reviewBtn = document.getElementById("reviewBtn");
    const closeModalBtn = document.getElementById("closeModalBtn");

    /***********************
     * 4) ìœ í‹¸
     ***********************/
    function normalizeKo(s){
      return (s ?? "").trim().replace(/\s+/g, " ");
    }
    function hintKo(ans){
      const CHO = ["ã„±","ã„²","ã„´","ã„·","ã„¸","ã„¹","ã…","ã…‚","ã…ƒ","ã……","ã…†","ã…‡","ã…ˆ","ã…‰","ã…Š","ã…‹","ã…Œ","ã…","ã…"];
      let out = "";
      for (const ch of ans){
        const code = ch.charCodeAt(0);
        if (code >= 0xAC00 && code <= 0xD7A3){
          const idx = Math.floor((code - 0xAC00) / (21 * 28));
          out += CHO[idx] ?? ch;
        } else if (ch === " ") {
          out += " ";
        } else {
          out += ch;
        }
      }
      return out;
    }
    function randInt(min, max){
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }
    function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }
    function shuffle(arr){
      for (let i = arr.length - 1; i > 0; i--){
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
    }
    function setLog(msg){ logEl.textContent = msg; }

    function sparkle(x, y){
      const s = document.createElement("div");
      s.className = "sparkle";
      s.style.left = x + "px";
      s.style.top = y + "px";
      s.textContent = "ğŸ’—âœ¨";
      rainZone.appendChild(s);
      setTimeout(() => s.remove(), 700);
    }

    /***********************
     * 5) ë ˆìŠ¨ ë¡œë”©
     ***********************/
    function populateLessonSelect(){
      lessonSelect.innerHTML = "";
      state.lessonKeys.forEach((k, i) => {
        const opt = document.createElement("option");
        opt.value = i;
        opt.textContent = k;
        lessonSelect.appendChild(opt);
      });
      lessonSelect.value = String(state.lessonIndex);
    }

    function loadLesson(index){
      state.lessonIndex = clamp(index, 0, state.lessonKeys.length - 1);
      const key = state.lessonKeys[state.lessonIndex];
      lessonTitle.textContent = key;

      state.remainQueue = [...LESSONS[key]];
      shuffle(state.remainQueue);

      updateSideStats();
      setLog(`ğŸ“˜ ${key} ì¤€ë¹„ ì™„ë£Œ! "ì‹œì‘"ì„ ëˆŒëŸ¬ì¤˜ â˜”ğŸ€`);
    }

    /***********************
     * 6) ê²Œì„ ì‹œì‘/ì¢…ë£Œ
     ***********************/
    function resetGame({ keepWrong=false } = {}){
      state.activeWords.forEach(w => w.el.remove());
      state.activeWords = [];

      state.score = 0;
      state.combo = 0;
      state.hp = 100;
      state.spawnTimer = 0;

      // âœ… ëŠë¦¬ê²Œ ì¬ì„¤ì •
      state.spawnInterval = 1600;
      state.baseSpeed = 0.3;
      state.paused = false;

      if (!keepWrong) state.wrongList = [];

      const key = state.lessonKeys[state.lessonIndex];
      if (state.mode === "review" && state.wrongList.length === 0){
        state.mode = "base";
      }

      if (state.mode === "base"){
        state.remainQueue = [...LESSONS[key]];
        shuffle(state.remainQueue);
        modePill.textContent = "ëª¨ë“œ: ê¸°ë³¸";
      } else {
        state.remainQueue = [...state.wrongList];
        shuffle(state.remainQueue);
        modePill.textContent = "ëª¨ë“œ: ì˜¤ë‹µë³µìŠµ";
      }

      state.running = true;
      hideModal();
      answerEl.value = "";
      answerEl.focus();

      updateHUD();
      updateSideStats();
      setLog("â˜” ì‹œì‘! ëœ»ì„ ì…ë ¥í•˜ê³  Enter! (í•‘í¬ì²œì²œíˆ ë²„ì „)");
    }

    function gameOver(){
      state.running = false;
      showModal(
        "ê²Œì„ ì˜¤ë²„ ğŸ’¥",
        `ì ìˆ˜: ${state.score}\nì˜¤ë‹µ(ë³µìŠµ ê°€ëŠ¥): ${state.wrongList.length}ê°œ`
      );
    }

    function clearLesson(){
      state.running = false;
      showModal(
        "ë ˆìŠ¨ í´ë¦¬ì–´ ğŸ‰",
        `ì ìˆ˜: ${state.score}\nì˜¤ë‹µ: ${state.wrongList.length}ê°œ\në‹¤ìŒ ë ˆìŠ¨ìœ¼ë¡œ ë„˜ì–´ê°ˆë˜?`
      );
    }

    /***********************
     * 7) ë‹¨ì–´ ìŠ¤í°/ì´ë™
     ***********************/
    function spawnWord(){
      if (state.remainQueue.length === 0) return;

      const wordData = state.remainQueue.pop();
      const el = document.createElement("div");
      el.className = "word";

      let html = `${wordData.jp}`;
      if (state.showReading && wordData.reading){
        html += `<small>${wordData.reading}</small>`;
      } else if (state.showHint){
        const baseAns = wordData.ko?.[0] ?? "";
        html += `<small>íŒíŠ¸: ${hintKo(baseAns)}</small>`;
      }
      el.innerHTML = html;

      const zoneRect = rainZone.getBoundingClientRect();
      const x = randInt(0, Math.max(0, Math.floor(zoneRect.width - 160)));
      const y = 10;

      el.style.left = x + "px";
      el.style.top = y + "px";

      rainZone.appendChild(el);

      // âœ… ì „ì²´ ì†ë„ ë‚®ì¶¤ + ëœë¤ í­ë„ ì‘ê²Œ
      state.activeWords.push({
        data: wordData,
        el,
        x, y,
        speed: (0.35 + Math.random()*0.25) * state.baseSpeed
      });

      updateSideStats();
    }

    function pushWrong(word){
      if (!state.wrongList.some(w => w.jp === word.jp)){
        state.wrongList.push(word);
      }
      wrongCountEl.textContent = String(state.wrongList.length);
    }

    function step(dt){
      const zoneRect = rainZone.getBoundingClientRect();
      const bottomLimit = zoneRect.height - 74;

      for (let i = state.activeWords.length - 1; i >= 0; i--){
        const w = state.activeWords[i];
        w.y += w.speed * dt * 0.9;
        w.el.style.top = w.y + "px";

        if (w.y >= bottomLimit){
          w.el.remove();
          state.activeWords.splice(i, 1);

          state.combo = 0;
          state.hp -= 10; // âœ… ì¡°ê¸ˆ ëœ ì•„í”„ê²Œ
          state.hp = clamp(state.hp, 0, 100);

          pushWrong(w.data);

          setLog(`ğŸ’§ ë†“ì¹¨! -HP (ë‚¨ì€ HP: ${state.hp})`);
          updateHUD();

          if (state.hp <= 0){
            gameOver();
            return;
          }
        }
      }

      if (state.remainQueue.length === 0 && state.activeWords.length === 0){
        clearLesson();
        return;
      }

      state.spawnTimer += dt;
      if (state.spawnTimer >= state.spawnInterval){
        state.spawnTimer = 0;
        spawnWord();

        // âœ… ë‚œì´ë„ ìƒìŠ¹ì„ ì•„ì£¼ ì²œì²œíˆ + ìµœëŒ€ë„ ë‚®ê²Œ
        state.baseSpeed = Math.min(0.8, state.baseSpeed + 0.003);
        state.spawnInterval = Math.max(900, state.spawnInterval - 2);

        updateHUD();
      }
    }

    /***********************
     * 8) ì •ë‹µ ì²˜ë¦¬
     ***********************/
    function submitAnswer(){
      if (!state.running || state.paused) return;

      const input = normalizeKo(answerEl.value);
      if (!input){
        setLog("âŒ¨ï¸ ëœ»ì„ ì…ë ¥í•´ì¤˜!");
        return;
      }

      const matches = state.activeWords
        .filter(w => (w.data.ko || []).some(ans => normalizeKo(ans) === input))
        .sort((a,b) => b.y - a.y);

      if (matches.length === 0){
        state.combo = 0;
        setLog(`âŒ ì˜¤ë‹µ: "${input}" (ë§ëŠ” ë‹¨ì–´ê°€ ì—†ì–´ìš”)`);
        updateHUD();
        return;
      }

      const target = matches[0];
      const rect = target.el.getBoundingClientRect();
      const zoneRect = rainZone.getBoundingClientRect();
      const fx = rect.left - zoneRect.left + rect.width/2;
      const fy = rect.top - zoneRect.top;

      target.el.remove();
      state.activeWords = state.activeWords.filter(w => w !== target);

      state.combo += 1;
      const gained = 10 + Math.min(30, state.combo * 2);
      state.score += gained;

      state.wrongList = state.wrongList.filter(w => w.jp !== target.data.jp);

      sparkle(fx, fy);

      setLog(`âœ… ì •ë‹µ! "${target.data.jp}" â†’ +${gained}ì  (ì½¤ë³´ ${state.combo}) ğŸ’—`);
      answerEl.value = "";

      updateHUD();
      updateSideStats();
    }

    /***********************
     * 9) HUD ì—…ë°ì´íŠ¸
     ***********************/
    function updateHUD(){
      scoreEl.textContent = String(state.score);
      comboEl.textContent = String(state.combo);
      speedEl.textContent = state.baseSpeed.toFixed(1);
      hpFill.style.width = state.hp + "%";
      wrongCountEl.textContent = String(state.wrongList.length);
    }
    function updateSideStats(){
      remainEl.textContent = String(state.remainQueue.length);
      wrongCountEl.textContent = String(state.wrongList.length);
    }

    /***********************
     * 10) ì¼ì‹œì •ì§€/ëª¨ë‹¬
     ***********************/
    function togglePause(){
      if (!state.running) return;
      state.paused = !state.paused;
      pauseBtn.textContent = state.paused ? "ì¬ê°œ" : "ì¼ì‹œì •ì§€";
      setLog(state.paused ? "â¸ï¸ ì¼ì‹œì •ì§€! (Pë¡œ ì¬ê°œ ê°€ëŠ¥)" : "â–¶ï¸ ì¬ê°œ!");
    }
    function showModal(title, desc){
      overlay.style.display = "flex";
      modalTitle.textContent = title;
      modalDesc.textContent = desc;
    }
    function hideModal(){ overlay.style.display = "none"; }

    /***********************
     * 11) ë©”ì¸ ë£¨í”„
     ***********************/
    function loop(now){
      const dt = now - state.lastTime;
      state.lastTime = now;

      if (state.running && !state.paused){
        step(dt);
      }

      requestAnimationFrame(loop);
    }

    /***********************
     * 12) ì´ë²¤íŠ¸
     ***********************/
    submitBtn.addEventListener("click", submitAnswer);
    answerEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter") submitAnswer();
    });
    pauseBtn.addEventListener("click", togglePause);

    startBtn.addEventListener("click", () => {
      state.mode = "base";
      modePill.textContent = "ëª¨ë“œ: ê¸°ë³¸";
      resetGame();
    });

    lessonSelect.addEventListener("change", () => {
      loadLesson(Number(lessonSelect.value));
    });

    toggleReadingBtn.addEventListener("click", () => {
      state.showReading = !state.showReading;
      toggleReadingBtn.textContent = state.showReading ? "ìš”ë¯¸ê°€ë‚˜ í‘œì‹œ" : "ìš”ë¯¸ê°€ë‚˜ ìˆ¨ê¹€";
      // í™”ë©´ì— ì´ë¯¸ ë– ìˆëŠ” ë‹¨ì–´ëŠ” ê·¸ëŒ€ë¡œ ë‘ê³  ë‹¤ìŒ ìŠ¤í°ë¶€í„° ë°˜ì˜
      setLog(state.showReading ? "ğŸ“– ìš”ë¯¸ê°€ë‚˜ ON" : "ğŸ“– ìš”ë¯¸ê°€ë‚˜ OFF");
    });

    toggleHintBtn.addEventListener("click", () => {
      state.showHint = !state.showHint;
      toggleHintBtn.textContent = state.showHint ? "íŒíŠ¸(ì´ˆì„±) í‘œì‹œ" : "íŒíŠ¸ ìˆ¨ê¹€";
      setLog(state.showHint ? "ğŸ’¡ íŒíŠ¸ ON (ë‹¤ìŒ ë‹¨ì–´ë¶€í„°)" : "ğŸ’¡ íŒíŠ¸ OFF");
    });

    document.addEventListener("keydown", (e) => {
      if (e.key.toLowerCase() === "p") togglePause();
    });

    restartBtn.addEventListener("click", () => resetGame({ keepWrong: true }));
    nextLessonBtn.addEventListener("click", () => {
      const next = Math.min(state.lessonKeys.length - 1, state.lessonIndex + 1);
      loadLesson(next);
      resetGame({ keepWrong: true });
    });
    reviewBtn.addEventListener("click", () => {
      state.mode = "review";
      modePill.textContent = "ëª¨ë“œ: ì˜¤ë‹µë³µìŠµ";
      resetGame({ keepWrong: true });
    });
    closeModalBtn.addEventListener("click", hideModal);

    /***********************
     * 13) ì´ˆê¸°í™”
     ***********************/
    populateLessonSelect();
    loadLesson(0);
    updateHUD();
    requestAnimationFrame(loop);
  </script>
</body>
</html>
